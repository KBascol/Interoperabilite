<!DOCTYPE html>
<html>
  <head>
    <title>Place searches</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <style>
      html, body, #map-canvas {
        height: 100%;
        margin: 0px;
        padding: 0px
      }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true&libraries=places,geometry"></script>
    <script>

var map;
var info;
var pyrmont;
var all_types;
var query = {}

location.search.substr(1).split("&").forEach(function(item) {query[item.split("=")[0]] = item.split("=")[1]})

var rad = function(x) {
  return x * Math.PI / 180;
};

var getDistance = function(p1, p2) {
  var R = 6378137; // Earthâ€™s mean radius in meter
  var dLat = rad(p2.lat() - p1.lat());
  var dLong = rad(p2.lng() - p1.lng());
  var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(rad(p1.lat())) * Math.cos(rad(p2.lat())) *
    Math.sin(dLong / 2) * Math.sin(dLong / 2);
  var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  var d = R * c;
  return d; // returns the distance in meter
};

function initialize() {
  all_types = query['q'];
  pyrmont = new google.maps.LatLng(query['lat'], query['lng']);
  info = document.getElementById('info');
  var request = {
    location: pyrmont,
    radius: query['rad'],
    types: all_types
  };
  map = new google.maps.Map(document.getElementById('map-canvas'), {
    center: pyrmont,
    zoom: 15
  });
  var service = new google.maps.places.PlacesService(map);
  service.nearbySearch(request, callback);
}

function callback(results, status) {
  info.innerHTML += "[ ";
  if (status == google.maps.places.PlacesServiceStatus.OK) {
    for (var i = 0; i < results.length; i++) {
      createList(results[i]);
      if ( i != (results.length - 1 )) {
        info.innerHTML += ",";
      }
    }
  }
  map = "";
  document.getElementById('map-canvas').innerHTML = "";
  info.innerHTML += "]";
}

function createList(place) {
  
  var placeLoc = place.geometry.location;
  var distance = getDistance(placeLoc, pyrmont);

  info.innerHTML += ("{ \"name\" : " + JSON.stringify(place.name) 
                   + ", \"adress\" : " + JSON.stringify(place.vicinity) 
                   + ", \"distance\" : " +  JSON.stringify(Number((distance).toFixed(3))) 
                   );
   for ( var i = 0; i < all_types.length; i++) {
        for ( var j = 0; j < place.types.length; j++ ) {
            if ( place.types[j] == all_types[i] ) {
                info.innerHTML += ", \"type\" : " + JSON.stringify(place.types[j]) + " } " ;
                return;
            }
        }
    }     


}


google.maps.event.addDomListener(window, 'load', initialize);

    </script>
  </head>
  <body>
    <div id="map-canvas" style="height: 0px; width: 0px;"></div>
    <div id="info"></div>
    <!-- 
        ?lat=45.441523611721365&lng=4.385610222816467&rad=500   Cinema test
        ?lat=45.4520887&lng=4.3866453&rad=500                   Fac
    -->
  </body>
</html>

